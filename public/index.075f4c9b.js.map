{"mappings":"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","sources":["node_modules/@parcel/runtime-js/lib/helpers/bundle-manifest.js","src/js/wgm_main_thread.js","src/js/const.js","node_modules/@parcel/runtime-js/lib/runtime-4d51a37677aff010.js","node_modules/@parcel/runtime-js/lib/runtime-baae1d648c54c9cb.js","node_modules/@parcel/runtime-js/lib/helpers/get-worker-url.js","node_modules/@parcel/runtime-js/lib/runtime-b29f1b520b25159e.js","src/js/main.js","node_modules/@parcel/runtime-js/lib/runtime-22ba9c7a74f387ed.js"],"sourcesContent":["\"use strict\";\n\nvar mapping = {};\n\nfunction register(pairs) {\n  var keys = Object.keys(pairs);\n\n  for (var i = 0; i < keys.length; i++) {\n    mapping[keys[i]] = pairs[keys[i]];\n  }\n}\n\nfunction resolve(id) {\n  var resolved = mapping[id];\n\n  if (resolved == null) {\n    throw new Error('Could not resolve bundle with id ' + id);\n  }\n\n  return resolved;\n}\n\nmodule.exports.register = register;\nmodule.exports.resolve = resolve;","// license:BSD-3-Clause\n// copyright-holders:Hiromasa Tanaka\nimport * as def from './const.js'\nimport worklet from 'worklet:./wgm_worklet_processor.js'; // worklet: Parcel\n\n/**\n * AudioWorklet Controller\n */\nexport class WgmController {\n    /**\n     * Constructor\n     *\n     * @param {ArrayBuffer} module WebAssembly module binary\n     * @param {number} samplingRate Sampling rate\n     * @param {number} loopMaxCount Max loop count\n     */\n    constructor(module, samplingRate, loopMaxCount) {\n        // WebAssembly binary\n        this.module = module;\n        // Worker and Worklet\n        this.worklet = null;\n        this.worker = null;\n        this.callback = null;\n        // shared memory Worker, Worklet\n        this.sharedRingL = [];\n        this.sharedRingR = [];\n        this.sharedStatus = null;\n        // sampling rate\n        this.samplingRate = samplingRate;\n        this.loopMaxCount = loopMaxCount;\n        this.chunkSize = def.AUDIO_WORKLET_SAMPLING_CHUNK * def.BUFFERING_CHUNK_COUNT;\n        this.feedOutRemain = 1; // 1chunk\n        this.feedOutSecond = Math.floor(this.chunkSize * this.feedOutRemain / samplingRate);\n        // init audio contexts\n        this.context = null;\n        this.gain = null;\n        this.analyser = null;\n        this.analyserBuffer = null;\n        this.analyserBufferLength = null;\n    }\n\n    /**\n     * prepare AudioContext and AudioWorklet\n     *\n     * Create Worklet and compile Webassembly in Worklet\n     *\n     * @param {AudioContext} context AudioContext\n     */\n    async prepare(context, callback) {\n        // set audio context\n        this.context = context;\n        // create shared memory\n        try {\n            for(let i = 0; i < def.BUFFER_RING_COUNT; i++) {\n                this.sharedRingL[i] = new SharedArrayBuffer(this.chunkSize * 4); // * 4: Float32Array;\n                this.sharedRingR[i] = new SharedArrayBuffer(this.chunkSize * 4); // * 4: Float32Array;\n            }\n            this.sharedStatus = new SharedArrayBuffer(1024); // Int32Array\n        } catch(e) {\n            return false;\n        }\n        // create Worker\n        this.worker = new Worker(new URL('wgm_worker.js', import.meta.url), {type: 'module'});\n        this.worker.onmessage = (event) => this.dispatch(event);\n        // create and compile Wasm Worker\n        this.sendWorker({\n            \"message\": \"compile\",\n            \"shared\": {\n                \"ringL\": this.sharedRingL,\n                \"ringR\": this.sharedRingR,\n                \"status\": this.sharedStatus,\n            }\n        }, async () => {\n            // create worklet\n            await this.context.audioWorklet.addModule(worklet);\n            callback();\n        });\n\n        return true;\n    }\n\n    /**\n     * Initialize Controller\n     *\n     * Initialize AudioNode Worklet and analyser\n     */\n    init() {\n        this.worklet = new AudioWorkletNode(this.context, \"wgm-worklet-processor\", {\n            \"numberOfInputs\": 1,\n            \"numberOfOutputs\": 1,\n            \"outputChannelCount\": [2], // 2ch stereo\n            \"processorOptions\": {\n                \"ringL\": this.sharedRingL,\n                \"ringR\": this.sharedRingR,\n                \"status\": this.sharedStatus,\n                \"chunkSteps\": def.BUFFERING_CHUNK_COUNT\n            }\n        });\n        // message dispatch\n        this.worklet.port.onmessage = (event) => this.dispatch(event);\n        // connect gain\n        this.gain = this.context.createGain();\n        this.gain.connect(this.context.destination);\n        // connect node\n        this.worklet.connect(this.gain);\n        // connect fft\n        this.analyser = this.context.createAnalyser();\n        this.analyserBufferLength = this.analyser.frequencyBinCount;\n        this.analyserBuffer = new Uint8Array(this.analyserBufferLength);\n        this.analyser.getByteTimeDomainData(this.analyserBuffer);\n        this.gain.connect(this.analyser);\n    }\n\n    /**\n     * Instance ready?\n     *\n     * @returns {boolean}\n     */\n    ready() {\n        if(this.worklet == null) {\n            return false;\n        }\n        return true;\n    }\n\n    /**\n     * Create playable instance\n     *\n     * @param {ArrayBuffer} wgmdata\n     * @param {string} type(vgm|xgm)\n     * @param {Function} callback(gd3meta)\n     */\n    create(wgmdata, type, callback) {\n        // Stop the current loop if there is one\n        // Stop Atomic wait via Worklet\n        this.sendWorklet({\"message\": \"stop\"}, () => {\n            this.sendWorker({\n                \"message\": \"create\",\n                \"wgmdata\": wgmdata,\n                \"type\": type,\n                \"options\": {\n                    \"samplingRate\": this.samplingRate,\n                    \"chunkSize\": this.chunkSize,\n                    \"loopMaxCount\": this.loopMaxCount,\n                    \"feedOutRemain\": this.feedOutRemain,\n                }\n            }, callback);\n        });\n    }\n\n    /**\n     * Start playback\n     *\n     * @param {Function} callback end music callback\n     */\n    play(callback) {\n        // return to 1.0\n        this.gain.gain.setValueAtTime(1, this.context.currentTime);\n        // start buffering\n        this.sendWorker({\"message\": \"start\"});\n        // start playback\n        this.sendWorklet({\"message\": \"play\"}, callback);\n    }\n\n    /**\n     * Get FFT data current time\n     *\n     * @returns FFT array buffer\n     */\n    getByteFrequencyData() {\n        this.analyser.getByteFrequencyData(this.analyserBuffer);\n        return this.analyserBuffer;\n    }\n\n    /**\n     * Get FFT data length\n     *\n     * @returns FFT array length\n     */\n    getAnalyserBufferLength() {\n        return this.analyserBufferLength;\n    }\n\n    /**\n     * Feed out music\n     */\n    feedout() {\n        const now = this.context.currentTime;\n        // feed out to 0.0\n        this.gain.gain.setValueAtTime(1, now);\n        this.gain.gain.linearRampToValueAtTime(0, now + this.feedOutSecond);\n    }\n\n    /**\n     * Message dispatcher\n     *\n     * @param {*} event\n     */\n    async dispatch(event) {\n        switch(event.data.message) {\n            case \"callback\": {\n                if(this.callback != null) {\n                    await this.callback(event.data.data);\n                }\n                break;\n            }\n            case \"feedout\": {\n                this.feedout();\n                break;\n            }\n        }\n    }\n\n    /**\n     * Send message to Worklet\n     *\n     * @param {*} message\n     * @param {Function} callback\n     */\n    sendWorklet(message, callback) {\n        // wait for a reply from the worklet\n        if(callback != null) {\n            this.callback = callback;\n        } else {\n            this.callback = null;\n        }\n        // sends a message to the Worklet\n        this.worklet.port.postMessage(message);\n    }\n\n    /**\n     * Send message to Worklet\n     *\n     * @param {*} message\n     * @param {Function} callback\n     */\n     sendWorker(message, callback) {\n        // wait for a reply from the worklet\n        if(callback != null) {\n            this.callback = callback;\n        } else {\n            this.callback = null;\n        }\n        // sends a message to the Worklet\n        this.worker.postMessage(message);\n    }\n}\n","// license:BSD-3-Clause\n// copyright-holders:Hiromasa Tanaka\n\n// Audio\nexport const AUDIO_WORKLET_SAMPLING_CHUNK = 128;\nexport const BUFFERING_CHUNK_COUNT = 768;\nexport const BUFFER_RING_COUNT = 4;\nexport const INIT_NOW_PLAYING_RING = 999;\n\n// Status SharedBuffer\nexport const NOW_PLAYING_RING = 0;\nexport const END_OF_MUSIC_CHUNK = 1;\nexport const FEED_OUT_START_CHUNK = 2;\n","module.exports = new __parcel__URL__(require('./helpers/bundle-manifest').resolve(\"frDq4\")).toString();","let workerURL = require('./helpers/get-worker-url');\nlet url = new __parcel__URL__(require('./helpers/bundle-manifest').resolve(\"eDdCm\"));\nmodule.exports = workerURL(url.toString(), url.origin, true);","\"use strict\";\n\nmodule.exports = function (workerUrl, origin, isESM) {\n  if (origin === self.location.origin) {\n    // If the worker bundle's url is on the same origin as the document,\n    // use the worker bundle's own url.\n    return workerUrl;\n  } else {\n    // Otherwise, create a blob URL which loads the worker bundle with `importScripts`.\n    var source = isESM ? 'import ' + JSON.stringify(workerUrl) + ';' : 'importScripts(' + JSON.stringify(workerUrl) + ');';\n    return URL.createObjectURL(new Blob([source], {\n      type: 'application/javascript'\n    }));\n  }\n};","require('./helpers/bundle-manifest').register(JSON.parse(\"{\\\"g3LtT\\\":\\\"index.075f4c9b.js\\\",\\\"frDq4\\\":\\\"wgm_worklet_processor.4d3ce39b.js\\\",\\\"eDdCm\\\":\\\"wgm_worker.9daa7062.js\\\",\\\"fpIuB\\\":\\\"libymfm_bg.b44913f8.wasm\\\"}\"));","// license:BSD-3-Clause\n// copyright-holders:Hiromasa Tanaka\nimport { WgmController } from \"./wgm_main_thread\";\n\n/**\n * VGM setting\n */\n const DEFAULT_SAMPLING_RATE = 44100;\n const LOOP_MAX_COUNT = 2;\n\n /**\n  * Canvas settings\n  */\n const CANVAS_WIDTH = 768;\n const CANVAS_HEIGHT = 576;\n const COLOR_MD_GREEN = '#00a040';\n const COLOR_MD_RED = '#e60012';\n const FONT_MAIN_STYLE = '16px sans-serif';\n\n/**\n * AudioWorklet Player\n * @type {WgmController}\n */\nlet player;\n\n/**\n * Audio context\n * @type {AudioContext}\n */\nlet audioContext = null;\nlet isAudioContextOpen = false;\n\n/**\n * VGM member\n */\nlet playlist = [];\nlet totalPlaylistCount;\nlet musicMeta;\nlet samplingRate = DEFAULT_SAMPLING_RATE;\n\n/**\n * Canvas\n * @type {HTMLCanvasElement}\n */\nlet canvas;\n\n/**\n * CanvasContext\n * @type {CanvasRenderingContext2D}\n */\nlet canvasContext;\n\nlet animId = null;\n\n/**\n * Canvas setting\n */\n(function() {\n    canvas = document.getElementById('screen');\n    canvas.setAttribute('width', CANVAS_WIDTH);\n    canvas.setAttribute('height', CANVAS_HEIGHT);\n    let pixelRatio = window.devicePixelRatio ? window.devicePixelRatio : 1;\n    if(pixelRatio > 1 && window.screen.width < CANVAS_WIDTH) {\n        canvas.style.width = 320 + \"px\";\n        canvas.style.heigth = 240 + \"px\";\n    }\n    canvasContext = canvas.getContext('2d');\n    canvasContext.font = '20px sans-serif';\n    canvasContext.fillStyle = COLOR_MD_GREEN;\n    // now loading\n    const nowloading = \"Now Loading...\";\n    let left = (CANVAS_WIDTH - canvasContext.measureText(nowloading).width) / 2;\n    canvasContext.fillText(nowloading, left, CANVAS_HEIGHT / 2 - 32);\n})();\n\n/**\n * Initialize system and start\n */\n(async function() {\n    /**\n     * Switch sampling rate for test (ex. https://.../#s=48000)\n     *\n     *  let context = new AudioContext({ sampleRate: samplingRate })\n     *\n     * (2021/9)\n     * Support Firefox only. (I haven't confirmed anything other than Linux platform)\n     * In other browsers, the setting works, but the native connection to the audio interface drops to 44100Hz.\n     * There is probably some downsampling going on inside the browser.\n     * Also, the setting itself may be invalid in Safari.\n     */\n    if(location.hash != \"\") {\n        const sample = location.hash.match(/^#s=(\\d+)/);\n        if(sample != null) {\n            samplingRate = parseInt(sample[1]);\n            if(samplingRate != samplingRate /* isNan */\n                || !(samplingRate == 44100 || samplingRate == 48000 || samplingRate == 88200 || samplingRate == 96000)) {\n                samplingRate = DEFAULT_SAMPLING_RATE;\n            }\n        }\n    }\n\n    /**\n     * Pre-fetch WebAssemby binary module\n     */\n    let module = await fetch(new URL('../wasm/libymfm_bg.wasm', import.meta.url));\n    module = new Uint8Array(await module.arrayBuffer())\n    player = new WgmController(module, samplingRate, LOOP_MAX_COUNT);\n\n    /**\n     * Create AudioContext and load WebAssembly module\n     */\n    audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: samplingRate });\n    if(!await player.prepare(audioContext, () => {\n        /**\n         * Start event loop\n         */\n        start();\n    })) {\n        systemError();\n    }\n})();\n\n/**\n * Start event loop\n */\nconst start = () => {\n    // print information\n    title();\n    canvasContext.fillStyle = COLOR_MD_GREEN;\n    canvasContext.font = '14px sans-serif';\n    fillTextCenterd(\"YM2149 | YM2151 | YM2203 | YM2413 | YM2608 | YM2610(B) | YM2612 | YM3526 | Y8950 | YM3812 | YMF262 | YMF278B\", CANVAS_HEIGHT / 2 - 32 * 4 + 16);\n    fillTextCenterd(\"SN76489(MD) | PWM(32X) | SEGAPCM | OKIM6258(X68K) | C140(C219) | OKIM6295\", CANVAS_HEIGHT / 2 - 32 * 3 + 4);\n    canvasContext.font = '20px sans-serif';\n    fillTextCenterd(\"🎶 DRAG AND DROP VGM(vgm/vgz) || XGM(xgm/xgz) HEAR\", CANVAS_HEIGHT / 2 - 32 * 1);\n    canvasContext.font = '15px sans-serif';\n    fillTextCenterd(\"or click to play sample music\", CANVAS_HEIGHT / 2 + 32 * 1);\n    printStatus();\n    // Set UI event\n    canvas.addEventListener('dragover', function(e) {\n        prevent(e);\n        canvas.style.border = '4px dotted #333333';\n        return false;\n    }, false);\n    canvas.addEventListener('dragleave', function(e) {\n        prevent(e);\n        canvas.style.border = '4px solid #000';\n        return false;\n    });\n    // drag to play\n    canvas.addEventListener('drop', onDrop, false);\n    // for sample music data\n    canvas.addEventListener('click', sample, false);\n};\n\n/**\n * System error\n */\nconst systemError = () => {\n    title();\n    fillTextCenterd(\"System initialize error.\", CANVAS_HEIGHT / 2 - 32 * 2);\n    canvasContext.font = '20px sans-serif';\n    canvasContext.fillStyle = COLOR_MD_GREEN;\n    fillTextCenterd(\"Your browser does not support SharedArrayBuffer.\", CANVAS_HEIGHT / 2);\n    fillTextCenterd(\"SharedArrayBuffer is supported by Firefox or Chromium systems.\", CANVAS_HEIGHT / 2 + 32);\n    // if(crossOriginIsolated) { // eslint-disable-line no-undef\n    //     fillTextCenterd(\"crossOriginIsolated is not set on the server.\", CANVAS_HEIGHT / 2);\n    // }\n    // no set event loop\n}\n\n/**\n * Title screen\n */\nconst title = () => {\n    canvasContext.fillStyle = 'rgb(0, 0, 0)';\n    canvasContext.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);\n    canvasContext.font = 'bold 28px sans-serif';\n    canvasContext.fillStyle = COLOR_MD_RED;\n    fillTextCenterd(\"WebAssembly 🎮 VGM Player\", CANVAS_HEIGHT / 2 - 32 * 5);\n}\n\n/**\n * Ready to play screen\n */\n const ready = () => {\n    title();\n    canvasContext.font = '28px sans-serif';\n    canvasContext.fillStyle = COLOR_MD_GREEN;\n    fillTextCenterd(\"OK! CLICK or TAP to start playback!\", CANVAS_HEIGHT / 2 + 32 * 6);\n\n    // Playback icon\n    canvasContext.arc(CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2, CANVAS_WIDTH / 8, 0 * Math.PI / 180, 360 * Math.PI / 180, false);\n    canvasContext.fillStyle = COLOR_MD_RED;\n    canvasContext.fill();\n    canvasContext.beginPath();\n    canvasContext.moveTo(CANVAS_WIDTH / 2 - 50 + 10, CANVAS_HEIGHT / 2 - 50);\n    canvasContext.lineTo(CANVAS_WIDTH / 2 - 50 + 10, CANVAS_HEIGHT / 2 + 50);\n    canvasContext.lineTo(CANVAS_WIDTH / 2 + 50 + 10, CANVAS_HEIGHT / 2);\n    canvasContext.closePath();\n    canvasContext.strokeStyle = \"#ffffff\";\n    canvasContext.stroke();\n    canvasContext.fillStyle = \"#ffffff\"\n    canvasContext.fill();\n\n    isAudioContextOpen = true;\n    canvas.addEventListener('click', next, false);\n}\n\n/**\n * Sample music\n */\nconst sample = async () => {\n    // sample music one time\n    canvas.removeEventListener('click', sample, false);\n    // it takes precedence over VGM metadata\n    musicMeta = createGd3meta({\n        track_name: \"🤍 Thank you for trying this player\",\n        track_name_j: \"\",\n        game_name: \"\",\n        game_name_j: \"A synthesizer written in WebAssembly\",\n        track_author: \"See the GitHub repository for more information\",\n        track_author_j: \"\"\n    });\n    const response = await fetch('./vgm/ym2612.vgm');\n    const bytes = await response.arrayBuffer();\n    // The sample music starts playing by clicking on it.\n    isAudioContextOpen = true;\n    // Play sample music\n    play(bytes, 'vgm', musicMeta);\n}\n\n/**\n * Event prevent\n *\n * @param {Event} e\n */\nconst prevent = function(e) {\n    e.preventDefault();\n    e.stopPropagation();\n};\n\n/**\n * Drag and Drop\n *\n * @param {DragEvent} ev\n * @returns false (prevent event)\n */\nconst onDrop = (ev) => {\n    prevent(ev);\n    // sample music one time\n    canvas.removeEventListener('click', sample, false);\n    // pause the drop event\n    canvas.removeEventListener('drop', onDrop, false);\n    canvas.style.border = '4px solid #000';\n    let filelist = {};\n    let files = ev.dataTransfer.files;\n    [].forEach.call(files, function(file) {\n        let reader = new FileReader();\n        reader.onload = function() {\n            filelist[file.name] = reader.result;\n            if(Object.keys(filelist).length >= files.length) {\n                // resume the drop event\n                canvas.addEventListener('drop', onDrop, false);\n                playlist = [];\n                Object.keys(filelist).sort().forEach(function(key) {\n                    playlist.push({ filename: key, xgmdata: filelist[key] });\n                });\n                totalPlaylistCount = playlist.length;\n                if(!isAudioContextOpen) {\n                    ready();\n                } else {\n                    next();\n                }\n            }\n        };\n        reader.readAsArrayBuffer(file);\n    });\n    return false;\n};\n\n/**\n * Play next playlist\n */\nconst next = function() {\n    canvas.removeEventListener('click', next, false);\n\n    if(playlist.length <= 0) return;\n\n    const target = playlist.shift();\n    let type = 'vgm';\n    if(/\\.xg[m|z]$/.test(target.filename)) {\n        type = 'xgm';\n    }\n    play(target.xgmdata, type);\n}\n\n/**\n * Play Music\n *\n * @param {ArrayBuffer} xgmfile\n * @param {string} type(vgm|xgm)\n * @param {*} altMeta\n */\nconst play = function(xgmfile, type, altMeta) {\n    // Worklet exchange callbacks\n    // iOS only sounds AudioWorklet that created by the click event.\n    // In the case of ScriptProcessorNode, I had to create an AudioContext here.\n    if(!player.ready()) {\n        // for Chromium\n        // \"The AudioContext was not allowed to start.\n        //  It must be resumed (or created) after a user gesture on the page.\"\n        audioContext.resume();\n        // create audionode and gain\n        player.init();\n    }\n    player.create(xgmfile, type, (gd3) => {\n        if(altMeta == null) {\n            musicMeta = createGd3meta(gd3);\n        }\n        if(animId != null) {\n            window.cancelAnimationFrame(animId);\n            animId = null;\n        }\n        draw();\n        player.play(next);\n    });\n};\n\n/**\n * Create GD3 meta\n *\n * @param {*} meta\n * @returns\n */\nconst createGd3meta = function(meta) {\n    meta.game_track_name = [meta.game_name, meta.track_name].filter(str => str != \"\").join(\" | \");\n    meta.game_track_name_j = [meta.game_name_j, meta.track_name_j].filter(str => str != \"\").join(\" / \");\n    meta.track_author_full = [meta.track_author, meta.track_author_j].filter(str => str != \"\").join(\" - \");\n    canvasContext.font = FONT_MAIN_STYLE;\n    meta.game_track_name_left = (CANVAS_WIDTH - canvasContext.measureText(meta.game_track_name).width) / 2;\n    meta.game_track_name_j_left = (CANVAS_WIDTH - canvasContext.measureText(meta.game_track_name_j).width) / 2;\n    meta.track_author_full_left = (CANVAS_WIDTH - canvasContext.measureText(meta.track_author_full).width) / 2;\n    return meta;\n};\n\n/**\n * Draw\n */\nconst draw = function() {\n    animId = window.requestAnimationFrame(draw);\n    canvasContext.fillStyle = 'rgb(0, 0, 0)';\n    canvasContext.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);\n\n    let audioAnalyserBuffer = player.getByteFrequencyData();\n    let audioAnalyserBufferLength = player.getAnalyserBufferLength();\n\n    canvasContext.lineWidth = 1;\n    canvasContext.beginPath();\n    canvasContext.strokeStyle = COLOR_MD_RED;\n\n    let width = 4;\n    let step =  Math.round(audioAnalyserBufferLength / (CANVAS_WIDTH / width));\n    canvasContext.setLineDash([2, 1]);\n    canvasContext.lineWidth = width ;\n    for(var i = 0; i < audioAnalyserBufferLength; i += step) {\n        canvasContext.beginPath();\n        canvasContext.moveTo(i + 2, CANVAS_HEIGHT);\n        canvasContext.lineTo(i + 2, CANVAS_HEIGHT - (audioAnalyserBuffer[i] * 1.5));\n        canvasContext.stroke();\n    }\n    canvasContext.stroke();\n\n    canvasContext.font = \"12px monospace\";\n    canvasContext.fillStyle = COLOR_MD_GREEN;\n    if(totalPlaylistCount >= 1) {\n        fillTextCenterd(\"Track \" + (totalPlaylistCount - playlist.length) + \" / \" + totalPlaylistCount, CANVAS_HEIGHT / 2 - 96);\n    }\n    canvasContext.font = FONT_MAIN_STYLE;\n    canvasContext.fillText(musicMeta.game_track_name, musicMeta.game_track_name_left, CANVAS_HEIGHT / 2 - 64);\n    canvasContext.fillText(musicMeta.game_track_name_j, musicMeta.game_track_name_j_left, CANVAS_HEIGHT / 2 - 32);\n    canvasContext.fillText(musicMeta.track_author_full, musicMeta.track_author_full_left, CANVAS_HEIGHT / 2);\n    printStatus();\n}\n\n/**\n * Print status\n */\nconst printStatus = function() {\n    if(samplingRate == 44100) return;\n\n    const status = \" HD:\" + samplingRate + \" \";\n    canvasContext.font = '16px sans-serif';\n    const measure = canvasContext.measureText(status);\n    canvasContext.fillStyle = COLOR_MD_GREEN;\n    canvasContext.fillRect(CANVAS_WIDTH - measure.width, 0, CANVAS_WIDTH, 18);\n    canvasContext.fillStyle = 'rgb(0, 0, 0)';\n    canvasContext.fillText(status, CANVAS_WIDTH - measure.width, 16);\n}\n\n/**\n * Fill text center\n *\n * @param {*} str\n * @param {*} height\n */\nconst fillTextCenterd = function(str, height) {\n    let left = (CANVAS_WIDTH - canvasContext.measureText(str).width) / 2;\n    canvasContext.fillText(str, left, height);\n}\n","module.exports = new __parcel__URL__(require('./helpers/bundle-manifest').resolve(\"fpIuB\")).toString();"],"names":["$18c11f3350a906ea$export$6503ec6e8aabbaf","$18c11f3350a906ea$export$f7ad0328861e2f03","$18c11f3350a906ea$var$mapping","pairs","keys","Object","i","length","id","resolved","Error","$2gP1w","parcelRequire","WgmController","constructor","module","samplingRate","loopMaxCount","this","worklet","worker","callback","sharedRingL","sharedRingR","sharedStatus","chunkSize","AUDIO_WORKLET_SAMPLING_CHUNK","BUFFERING_CHUNK_COUNT","feedOutRemain","feedOutSecond","Math","floor","context","gain","analyser","analyserBuffer","analyserBufferLength","async","BUFFER_RING_COUNT","SharedArrayBuffer","e","Worker","onmessage","event","dispatch","sendWorker","message","shared","ringL","ringR","status","audioWorklet","addModule","$parcel$interopDefault","$bHfhW","init","AudioWorkletNode","numberOfInputs","numberOfOutputs","outputChannelCount","processorOptions","chunkSteps","port","createGain","connect","destination","createAnalyser","frequencyBinCount","Uint8Array","getByteTimeDomainData","ready","create","wgmdata","type","sendWorklet","options","play","setValueAtTime","currentTime","getByteFrequencyData","getAnalyserBufferLength","feedout","now","linearRampToValueAtTime","data","postMessage","$1a74a79c52946617$export$82474fc2c4d8bff0","$1a74a79c52946617$export$6a88b8329b4d35e5","$1a74a79c52946617$export$2497303df528ce88","exports","URL","resolve","import","meta","url","toString","$7ryUf","$aca88a72491dc3ac$var$url","origin","workerUrl","isESM","self","location","source","JSON","stringify","createObjectURL","Blob","register","parse","$4wLdb","$54b47fc030b7b21e$var$player","$54b47fc030b7b21e$var$totalPlaylistCount","$54b47fc030b7b21e$var$musicMeta","$54b47fc030b7b21e$var$canvas","$54b47fc030b7b21e$var$canvasContext","$54b47fc030b7b21e$var$audioContext","$54b47fc030b7b21e$var$isAudioContextOpen","$54b47fc030b7b21e$var$playlist","$54b47fc030b7b21e$var$samplingRate","$54b47fc030b7b21e$var$animId","document","getElementById","setAttribute","window","devicePixelRatio","screen","width","style","heigth","getContext","font","fillStyle","nowloading","left","measureText","fillText","$54b47fc030b7b21e$var$CANVAS_HEIGHT","$893d73acdfa90ef4$exports","hash","sample1","match","parseInt","fetch","arrayBuffer","AudioContext","webkitAudioContext","sampleRate","prepare","$54b47fc030b7b21e$var$start","$54b47fc030b7b21e$var$systemError","$54b47fc030b7b21e$var$title","$54b47fc030b7b21e$var$fillTextCenterd","$54b47fc030b7b21e$var$printStatus","addEventListener","$54b47fc030b7b21e$var$prevent","border","$54b47fc030b7b21e$var$onDrop","$54b47fc030b7b21e$var$sample","fillRect","removeEventListener","$54b47fc030b7b21e$var$createGd3meta","track_name","track_name_j","game_name","game_name_j","track_author","track_author_j","response","bytes","$54b47fc030b7b21e$var$play","preventDefault","stopPropagation","ev","filelist","files","dataTransfer","forEach","call","file","reader","FileReader","onload","name","result","sort","key","push","filename","xgmdata","$54b47fc030b7b21e$var$next","arc","$54b47fc030b7b21e$var$CANVAS_WIDTH","PI","fill","beginPath","moveTo","lineTo","closePath","strokeStyle","stroke","readAsArrayBuffer","target","shift","test","xgmfile","altMeta","resume","gd3","cancelAnimationFrame","$54b47fc030b7b21e$var$draw","game_track_name","filter","str","join","game_track_name_j","track_author_full","game_track_name_left","game_track_name_j_left","track_author_full_left","requestAnimationFrame","audioAnalyserBuffer","audioAnalyserBufferLength","lineWidth","step","round","setLineDash","measure","height"],"version":3,"file":"index.075f4c9b.js.map"}