function t(t,e,n,r){Object.defineProperty(t,e,{get:n,set:r,enumerable:!0,configurable:!0})}var e={};function n(){}function r(){}let o;function s(t){o=t}t(e,"setWasmExport",(()=>s)),t(e,"WgmPlay",(()=>w)),t(e,"__wbg_new_59cb74e423758ede",(()=>b)),t(e,"__wbg_stack_558ba5917b466edd",(()=>$)),t(e,"__wbg_error_4bb6c2a97407129a",(()=>k)),t(e,"__wbindgen_object_drop_ref",(()=>v)),t(e,"__wbindgen_throw",(()=>O)),n.prototype.encode=function(t){for(var e=[],n=t.length,r=0;r<n;){var o=t.codePointAt(r),s=0,a=0;for(o<=127?(s=0,a=0):o<=2047?(s=6,a=192):o<=65535?(s=12,a=224):o<=2097151&&(s=18,a=240),e.push(a|o>>s),s-=6;s>=0;)e.push(128|o>>s&63),s-=6;r+=o>=65536?2:1}return e},r.prototype.decode=function(t){var e="",n=0;if(null!=t){for(;n<t.length;){var r=t[n],o=0,s=0;if(r<=127?(o=0,s=255&r):r<=223?(o=1,s=31&r):r<=239?(o=2,s=15&r):r<=244&&(o=3,s=7&r),t.length-n-o>0)for(var a=0;a<o;)s=s<<6|63&(r=t[n+a+1]),a+=1;else s=65533,o=t.length-n;e+=String.fromCodePoint(s),n+=o+1}return e}};const a=new Array(32).fill(void 0);function i(t){return a[t]}a.push(void 0,null,!0,!1);let l=a.length;function _(t){const e=i(t);return function(t){t<36||(a[t]=l,l=t)}(t),e}let c=new r("utf-8",{ignoreBOM:!0,fatal:!0});c.decode();let u=null;function g(){return null!==u&&u.buffer===o.memory.buffer||(u=new Uint8Array(o.memory.buffer)),u}function f(t,e){return c.decode(g().subarray(t,t+e))}let p=null;function h(){return null!==p&&p.buffer===o.memory.buffer||(p=new Int32Array(o.memory.buffer)),p}let d=0;let m=new n("utf-8");const y="function"==typeof m.encodeInto?function(t,e){return m.encodeInto(t,e)}:function(t,e){const n=m.encode(t);return e.set(n),{read:t.length,written:n.length}};class w{static __wrap(t){const e=Object.create(w.prototype);return e.ptr=t,e}__destroy_into_raw(){const t=this.ptr;return this.ptr=0,t}free(){const t=this.__destroy_into_raw();o.__wbg_wgmplay_free(t)}constructor(t,e,n){var r=o.wgmplay_from(t,e,n);return w.__wrap(r)}get_seq_data_ref(){return o.wgmplay_get_seq_data_ref(this.ptr)}get_sampling_l_ref(){return o.wgmplay_get_sampling_l_ref(this.ptr)}get_sampling_r_ref(){return o.wgmplay_get_sampling_r_ref(this.ptr)}get_seq_header(){try{const n=o.__wbindgen_add_to_stack_pointer(-16);o.wgmplay_get_seq_header(n,this.ptr);var t=h()[n/4+0],e=h()[n/4+1];return f(t,e)}finally{o.__wbindgen_add_to_stack_pointer(16),o.__wbindgen_free(t,e)}}get_seq_gd3(){try{const n=o.__wbindgen_add_to_stack_pointer(-16);o.wgmplay_get_seq_gd3(n,this.ptr);var t=h()[n/4+0],e=h()[n/4+1];return f(t,e)}finally{o.__wbindgen_add_to_stack_pointer(16),o.__wbindgen_free(t,e)}}init(){return 0!==o.wgmplay_init(this.ptr)}play(){return o.wgmplay_play(this.ptr)>>>0}}function b(){return function(t){l===a.length&&a.push(a.length+1);const e=l;return l=a[e],a[e]=t,e}(new Error)}function $(t,e){var n=function(t,e,n){if(void 0===n){const n=m.encode(t),r=e(n.length);return g().subarray(r,r+n.length).set(n),d=n.length,r}let r=t.length,o=e(r);const s=g();let a=0;for(;a<r;a++){const e=t.charCodeAt(a);if(e>127)break;s[o+a]=e}if(a!==r){0!==a&&(t=t.slice(a)),o=n(o,r,r=a+3*t.length);const e=g().subarray(o+a,o+r);a+=y(t,e).written}return d=a,o}(i(e).stack,o.__wbindgen_malloc,o.__wbindgen_realloc),r=d;h()[t/4+1]=r,h()[t/4+0]=n}function k(t,e){try{console.error(f(t,e))}finally{o.__wbindgen_free(t,e)}}function v(t){_(t)}function O(t,e){throw new Error(f(t,e))}var A={};t(A,"fd_seek",(()=>C)),t(A,"fd_write",(()=>x)),t(A,"fd_close",(()=>M)),t(A,"fd_fdstat_get",(()=>q)),t(A,"path_open",(()=>S)),t(A,"fd_fdstat_set_flags",(()=>z)),t(A,"fd_read",(()=>P)),t(A,"environ_sizes_get",(()=>R)),t(A,"proc_exit",(()=>W)),t(A,"environ_get",(()=>j)),t(A,"random_get",(()=>E));const C=function(t,e,n,r){console.log(`fd_seek: ${t}, ${e}, ${n}, ${r}`)},x=function(t,e,n,r){console.log(`fd_write: ${t}, ${e}, ${n}, ${r}`)},M=function(t){console.log(`fd_close: ${t}`)},q=function(t,e){console.log(`fd_fdstat_get: ${t}, ${e}`)},S=function(t,e,n,r,o,s,a,i,l){console.log(`path_open: ${t}, ${e}, ${n}, ${r}, ${o}, ${s}, ${a}, ${i}, ${l}`)},z=function(t,e,n,r,o,s,a,i,l){console.log(`fd_fdstat_set_flags: ${t}, ${e}, ${n}, ${r}, ${o}, ${s}, ${a}, ${i}, ${l}`)},P=function(t,e,n,r){console.log(`fd_fdstat_get: ${t}, ${e}, ${n}, ${r}`)},R=function(t,e){console.log(`environ_sizes_get: ${t}, ${e}`)},W=function(t){console.log(`proc_exit: ${t}`)},j=function(t,e){console.log(`environ_get: ${t}, ${e}`)},E=function(t,e){return console.log(`random_get: ${t}, ${e}`),0};class I extends AudioWorkletProcessor{constructor(t){super();const e=t.processorOptions;this.module=e.module,this.samplingRate=e.samplingRate,this.chunkSize=e.chunkSize,this.loopMaxCount=e.loopMaxCount,this.feedOutRemain=e.feedOutRemain,this.wgmplay=null,this.memory=null,this.play=!1,this.feedOutCount=0,this.port.onmessage=t=>this.dispatch(t)}process(t,e,n){if(!this.play)return!0;try{const t=this.wgmplay.play();return e[0][0].set(new Float32Array(this.memory.buffer,this.wgmplay.get_sampling_l_ref(),this.chunkSize)),e[0][1].set(new Float32Array(this.memory.buffer,this.wgmplay.get_sampling_r_ref(),this.chunkSize)),t>=this.loopMaxCount&&(0==this.feedOutCount&&t>this.loopMaxCount?(this.play=!1,this.port.postMessage({message:"callback",data:"OK"})):(0==this.feedOutCount&&this.port.postMessage({message:"feedout"}),this.feedOutCount++,this.feedOutCount>this.feedOutRemain&&(this.play=!1,this.port.postMessage({message:"callback",data:"OK"})))),!0}catch(t){return this.play=!1,console.log(`An unexpected error has occurred. System has stoped. Please reload brwoser.\n${t}`),!1}}async dispatch(t){switch(t.data.message){case"compile":await this.compile(),this.port.postMessage({message:"callback",data:"OK"});break;case"create":this.port.postMessage({message:"callback",data:this.create(t.data.vgmdata)});break;case"play":this.play=!0}}async compile(){const t=await async function(t){let n=await WebAssembly.compile(t),r={};return r.wasi_snapshot_preview1=A,r["./libymfm_bg.js"]=e,(await WebAssembly.instantiate(n,{...r})).exports}(this.module);s(t),this.memory=t.memory}create(t){return null!=this.wgmplay&&(this.wgmplay.free(),this.wgmplay=null),this.wgmplay=new w(this.samplingRate,this.chunkSize,t.byteLength),new Uint8Array(this.memory.buffer,this.wgmplay.get_seq_data_ref(),t.byteLength).set(new Uint8Array(t)),this.wgmplay.init()||(this.wgmplay.free(),this.wgmplay=null),this.feedOutCount=0,JSON.parse(this.wgmplay.get_seq_gd3())}}registerProcessor("wgm-worklet-processor",I);
//# sourceMappingURL=wgm_worklet_processor.87511085.js.map
